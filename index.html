<!DOCTYPE html>
<html>
<head>
    <title>太空侵略者</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="css/core.css">
    <link rel="stylesheet" type="text/css" href="css/typeography.css">
    <style>

        /* Styling needed for a fullscreen canvas and no scrollbars. */
        body, html {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #starfield {
            width: 100%;
            height: 100%;
            z-index: -1;
            position: absolute;
            left: 0px;
            top: 0px;
        }

        #gamecontainer {
            width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        #gamecanvas {
            width: 800px;
            height: 600px;
        }

        #info {
            width: 800px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }

        .score-container {
            position: absolute;
            top: 50px;
            z-index: 2;
            left: 50%;
            transform: translateX(400px);
            padding: 30px 30px;
            color: #ffffff;
            background: #333333;
            opacity: 0.85;
            border-radius: 5px;
            height: 500px;
            max-height: 500px;
            overflow: scroll;
            max-width: 300px;
            width: 300px;
        }

        .rank li {
            list-style: none;
        }

        .rank li p {
            padding: 5px 0;
        }

        .score {
            display: inline-block;
            width: 60px;
        }

        .username {
            display: inline-block;
            width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            vertical-align: bottom;
        }

        .level {
            display: inline-block;
            width: 60px;
        }

        #nameChange {
            display: none;
        }

        .user {
            cursor: pointer;
        }

        .highestScore {
            font-size: 16px;
            font-weight: normal;
            margin-left: 20px;
        }
        .first{
            color: rgb(218,178,115 );
        }
        .second{
            color: rgb(233,233,216 );
        }
        .third{
            color: rgb(186,110,64);
        }

    </style>
</head>
<body>
<div id="starfield"></div>
<div id="gamecontainer">
    <canvas id="gameCanvas"></canvas>
</div>
<div id="info">
    <p>使用方向键移动,空格发射. 每升一级侵略者和炸弹速度会越来越快</p>
    <p><a id="muteLink" href="#" onclick="toggleMute()">mute</a> |
</div>
<div class="score-container">
    <h3>
        <span class="user">

        </span>
        <span class="highestScore">
        </span>
        <p id="nameChange">
            <input type="text" id="username" name="username"/>
            <button id="nameBtn">确定</button>
            <button id="cancelBtn">取消</button>
        </p>

    </h3>
    <p>最佳排名：</p>
    <ul class="rank">
        <li>
            <p>
                加载中...
            </p>
        </li>
    </ul>
</div>

<script src="js/starfield.js"></script>
<script src="js/spaceinvaders.js"></script>
<script src="js/nebulas.js"></script>
<script src="js/nebPay.js"></script>
<script>

    //  Create the starfield.
    var container = document.getElementById('starfield');
    var starfield = new Starfield();
    starfield.initialise(container);
    starfield.start();

    var lastHightScore = 0;

    //  Setup the canvas.
    var canvas = document.getElementById("gameCanvas");
    canvas.width = 800;
    canvas.height = 600;

    //  Create the game.
    var game = new Game();

    //  Initialise it with the game canvas.
    game.initialise(canvas);

    //  Start the game.
    game.start();

    //  Listen for keyboard events.
    window.addEventListener("keydown", function keydown(e) {
        var keycode = e.which || window.event.keycode;
        //  Supress further processing of left/right/space (37/29/32)
        if (keycode == 37 || keycode == 39 || keycode == 32) {
            e.preventDefault();
        }
        game.keyDown(keycode);
    });
    window.addEventListener("keyup", function keydown(e) {
        var keycode = e.which || window.event.keycode;
        game.keyUp(keycode);
    });

    function toggleMute() {
        game.mute();
        document.getElementById("muteLink").innerText = game.sounds.mute ? "unmute" : "mute";
    }

    var account = null;
    window.addEventListener('message', function (e) {
        if (e.data.data && !!e.data.data.account) {
            account = e.data.data.account;
        }
    });
    window.postMessage({
        "target": "contentscript",
        "data": {},
        "method": "getAccount",
    }, "*");

    window.onload = function () {

        var NebPay = require("nebpay");     //https://github.com/nebulasio/nebPay
        var nebPay = new NebPay();

        var HttpRequest = require("nebulas").HttpRequest;
        var Neb = require("nebulas").Neb;
        var neb = new Neb();
        neb.setRequest(new HttpRequest("https://mainnet.nebulas.io"));

        var testNeb = new Neb();
        testNeb.setRequest(new HttpRequest("https://testnet.nebulas.io"));

        var testNet = true;
        var testDappAddress = "n1tx8y8LYeQeqJGEyn4SspVAY48nCg5QCRg";
        var txhash = null;
        var scoretxhash = null;

        var internal = null;
        var sinternal = null;

        document.querySelector(".user").addEventListener('click', function () {
            this.style.display = 'none';
            document.getElementById("nameChange").style.display = "inline-block";
            document.querySelector(".highestScore").style.display = "none";
            var name = document.querySelector(".user").innerText;
            document.getElementById("username").value = name;
        })
        document.getElementById("cancelBtn").addEventListener('click', function () {
            document.getElementById("nameChange").style.display = "none";
            document.querySelector(".user").style.display = "inline-block";
            document.querySelector(".highestScore").style.display = "inline-block";
        })

        document.getElementById("nameBtn").addEventListener("click", function () {
            var newName = document.getElementById("username").value;
            var to = testDappAddress;
            var value = "0";
            var callFunction = "changeUsername"
            var callArgs = "[\"" + newName + "\"]";
            if (testNet) {
                to = testDappAddress;
            } else {
                to = testDappAddress;
            }
            nebPay.call(to, value, callFunction, callArgs, {
                listener: cbPush
            });

            internal = window.setInterval(function () {

                if (testNet) {
                    getTransactionReceipt(testNeb, newName);
                } else {
                    getTransactionReceipt(neb, newName);
                }
            }, 10000)

        });

        function getTransactionReceipt(neb, newName) {

            neb.api.getTransactionReceipt(txhash)
                .then(function (resp) {
                    if (resp && resp.status == 1) {
                        document.querySelector(".user").innerText = newName;
                        document.getElementById("nameChange").style.display = "none";
                        document.querySelector(".user").style.display = "inline-block";
                        document.querySelector(".highestScore").style.display = "inline-block";
                        txhash = null;
                        window.location.reload();
                        window.clearInterval(internal);
                    }
                })
                .catch(function (err) {
                    txhash = null;
                    window.clearInterval(internal);
                    alert("出错了：" + err);
                });
        }

        function cbPush(resp) {
            txhash = resp.txhash;
        }

        if (typeof(webExtensionWallet) === "undefined") {
            alert("请先安装星云钱包浏览器插件");
        } else {
            getName();
            getRank();

            game.over = function () {
                var score = game.score;
                var level = game.level;
                if(score > lastHightScore){
                    score(score, level);
                }
            }
        }

        function score(score, level) {

            var to = testDappAddress;
            var value = "0";
            var callFunction = "score"
            var date = getDate();
            var callArgs = "[\"" + score + "\",\"" + level + "\",\"" + date + "\"]";
            if (testNet) {
                to = testDappAddress;
            } else {
                to = testDappAddress;
            }
            nebPay.call(to, value, callFunction, callArgs, {
                listener: scorePush
            });

            sinternal = window.setInterval(function () {

                if (testNet) {
                    getScoreTransactionReceipt(testNeb);
                } else {
                    getScoreTransactionReceipt(neb);
                }
            }, 10000)
        }

        function getScoreTransactionReceipt(neb) {

            neb.api.getTransactionReceipt(txhash)
                .then(function (resp) {
                    if (resp && resp.status == 1) {
                        scoretxhash=null;
                        window.clearInterval(sinternal);
                        alert("提交成功");
                    }
                })
                .catch(function (err) {
                    scoretxhash=null;
                    window.clearInterval(sinternal);
                    alert("出错了：" + err);
                });
        }

        function scorePush(resp) {
            scoretxhash = resp.txhash;
        }

        function getDate() {
            var date = new Date();
            var seperator1 = "-";
            var year = date.getFullYear();
            var month = date.getMonth() + 1;
            var strDate = date.getDate();
            if (month >= 1 && month <= 9) {
                month = "0" + month;
            }
            if (strDate >= 0 && strDate <= 9) {
                strDate = "0" + strDate;
            }
            var currentdate = year + seperator1 + month + seperator1 + strDate;
            return currentdate;
        }

        function getName() {
            var from = account;
            var value = "0";
            var nonce = "0";
            var gas_price = "1000000";
            var gas_limit = "2000000";
            var callFunction = "get";
            var callArgs = ""; //in the form of ["args"]
            var contract = {
                "function": callFunction,
                "args": callArgs
            };

            function cbSearch(resp) {
                var result = resp.result;
                if (result) {
                    try {
                        result = JSON.parse(result)
                    } catch (err) {
                        this.showDialogs("异常", "智能合约返回数据异常！", false, true);
                    }

                    if(result){
                        document.querySelector(".user").innerText = result.name;
                        document.querySelector(".highestScore").innerText = "最高得分：" + result.score;
                        lastHightScore = result.score;
                    }else {
                        document.querySelector(".user").innerText = '匿名用户';
                        document.querySelector(".highestScore").innerText = "点击修改";
                    }
                } else {
                    alert("查询账户地址用户名异常！");
                }
            }

            if (testNet) {
                testNeb.api.call(from, testDappAddress, value, nonce, gas_price, gas_limit, contract).then(function (resp) {
                    cbSearch(resp)
                }).catch(function (err) {
                    alert("出错了：" + err);
                })
            } else {
                neb.api.call(from, testDappAddress, value, nonce, gas_price, gas_limit, contract).then(function (resp) {
                    cbSearch(resp)
                }).catch(function (err) {
                    alert("出错了：" + err);
                })
            }
        }

        function getRank() {
            var from = account;
            var value = "0";
            var nonce = "0";
            var gas_price = "1000000";
            var gas_limit = "2000000";
            var callFunction = "query";
            var callArgs = "[200,0]"; //in the form of ["args"]
            var contract = {
                "function": callFunction,
                "args": callArgs
            };

            function querySearch(resp) {
                var result = resp.result;
                if (result) {
                    try {
                        result = JSON.parse(result)
                        var invaders = result.invaders;
                        invaders.sort(compare);
                        invaders.slice(0, 2);
                        console.log(invaders)
                        if (invaders && invaders.length > 0) {
                            var r = "";
                            for (var i = 0; i < invaders.length; i++) {
                                r += '<li> <p> <span class=" username ">' + invaders[i].name + '</span> <span class=" score ">' + invaders[i].score + '分</span> <span class=" level ">等级 ' + invaders[i].level + '</span> </p> </li>'
                            }

                            document.querySelector(".rank").innerHTML = r;
                        } else {
                            document.querySelector(".rank").innerHTML = "<li>还未有用户排名数据</li>";
                        }
                    } catch (err) {
                        alert("异常！" + err);
                    }
                    console.log("query result" + result);
                } else {

                }
            }

            if (testNet) {
                testNeb.api.call(from, testDappAddress, value, nonce, gas_price, gas_limit, contract).then(function (resp) {
                    querySearch(resp)
                }).catch(function (err) {
                    alert("出错了：" + err);
                })
            } else {
                neb.api.call(from, testDappAddress, value, nonce, gas_price, gas_limit, contract).then(function (resp) {
                    querySearch(resp)
                }).catch(function (err) {
                    alert("出错了：" + err);
                })
            }
        }

        function compare(a, b) {
            // Use toUpperCase() to ignore character casing
            var scoreA = a.score;
            var scoreB = b.score;

            var comparison = 0;
            if (scoreA > scoreB) {
                comparison = -1;
            } else if (scoreA < scoreB) {
                comparison = 1;
            }
            return comparison;
        }

    }
</script>
</body>
</html>